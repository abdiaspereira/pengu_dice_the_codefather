<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pengu Dice ‚Äì Web</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

    <style>
      /* Fondo con degradado en las 4 esquinas */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background:
          radial-gradient(circle at top left, red, transparent 60%),
          radial-gradient(circle at top right, yellow, transparent 60%),
          radial-gradient(circle at bottom left, green, transparent 60%),
          radial-gradient(circle at bottom right, blue, transparent 60%);
        z-index: -1;
      }

      /* Confeti */
      .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        background: #f0f;
        position: fixed;
        left: 50%;
        animation: confetti-fall 3s linear forwards;
        z-index: 1000;
      }

      @keyframes confetti-fall {
        to {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }
    </style>
  </head>

  <body class="text-gray-100 font-sans min-h-screen flex flex-col relative overflow-y-auto">
    <!-- Header -->
    <header class="bg-gray-800 bg-opacity-80 shadow-lg py-4 mb-6">
      <h1 class="text-3xl text-center font-bold text-white drop-shadow-md">
        üéÆ Pengu Dice üêß Webpage
      </h1>
    </header>

    <!-- Contenido principal -->
    <main class="flex flex-col items-center flex-grow space-y-6 pb-10">
      <!-- Estado -->
      <div id="statusBox" class="px-4 py-2 bg-gray-800 bg-opacity-70 rounded-lg shadow">
        Estado: <span id="status" class="font-bold text-yellow-400">Conectando...</span>
      </div>

      <!-- Imagen y bot√≥n -->
      <div class="flex flex-col justify-center items-center flex-grow space-y-6">
        <img src="{{ url_for('static', filename='pengu_dice.png') }}" alt="Ping√ºino" class="w-64 h-auto">

        <button id="startBtn"
          class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold px-6 py-3 rounded-xl shadow-lg transition disabled:bg-gray-500 disabled:cursor-not-allowed disabled:hover:bg-gray-500">
          ‚ñ∂Ô∏è Iniciar Juego
        </button>
      </div>

      <!-- Panel de puntaje -->
      <div id="scorePanel" class="text-center hidden">
        <h2 class="text-xl mb-2 text-gray-300">Puntaje final</h2>
        <p id="finalScore" class="text-4xl font-bold text-emerald-400">0</p>
        <div class="mt-4">
          <input id="playerName" type="text" placeholder="Tu nombre"
            class="px-3 py-2 rounded bg-gray-800 border border-gray-600 focus:outline-none focus:ring focus:ring-emerald-500" />
          <button id="saveScore"
            class="ml-2 bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg font-semibold">üíæ Guardar Puntaje</button>
        </div>
      </div>

      <!-- Ranking -->
      <section class="w-full max-w-2xl">
        <h2 class="text-2xl text-center font-semibold mb-3 text-emerald-300">
          üèÜ Puntaje Hist√≥rico
        </h2>
        <div class="bg-gray-800 bg-opacity-70 rounded-lg shadow overflow-hidden">
          <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-700">
              <tr>
                <th class="px-4 py-2 text-left">Jugador</th>
                <th class="px-4 py-2 text-right">Puntaje</th>
                <th class="px-4 py-2 text-right">Fecha</th>
              </tr>
            </thead>
            <tbody id="rankingBody" class="divide-y divide-gray-700">
              {% for s in scores %}
              <tr>
                <td class="px-4 py-2">{{ s.name }}</td>
                <td class="px-4 py-2 text-right">{{ s.score }}</td>
                <td class="px-4 py-2 text-right">{{ s.timestamp.strftime('%Y-%m-%d') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Bot√≥n eliminar DB -->
        <div class="flex justify-center mt-4">
          <button id="deleteDbBtn"
            class="bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-3 rounded-xl shadow-lg transition">
            üóëÔ∏è Eliminar Base de Datos
          </button>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="text-center text-gray-300 py-4 text-sm mt-10">
      Desarrollado por the_codefather üíª | Flask + Socket.IO + Arduino
    </footer>

    <!-- Script principal -->
    <script>
      const socket = io();
      const statusEl = document.getElementById("status");
      const scorePanel = document.getElementById("scorePanel");
      const finalScoreEl = document.getElementById("finalScore");
      const playerNameEl = document.getElementById("playerName");
      const startBtn = document.getElementById("startBtn");

      let gameInProgress = false;

      // Funci√≥n para crear confeti
      function createConfetti() {
        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#ff1493'];
        const confettiCount = 100;

        for (let i = 0; i < confettiCount; i++) {
          setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 0.5 + 's';
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            document.body.appendChild(confetti);

            setTimeout(() => confetti.remove(), 3500);
          }, i * 30);
        }
      }

      // Estado de conexi√≥n
      socket.on("connect", () => {
        statusEl.textContent = "Conectado ‚úÖ";
        statusEl.className = "font-bold text-emerald-400";
      });

      socket.on("disconnect", () => {
        statusEl.textContent = "Desconectado ‚ùå";
        statusEl.className = "font-bold text-red-400";
      });

      socket.on("status", (data) => {
        statusEl.textContent = data.status === "ready" ? "Listo üéØ" : data.status;
      });

      // Iniciar juego
      startBtn.addEventListener("click", async () => {
        const res = await fetch("/start", { method: "POST" });
        const data = await res.json();
        if (data.status === "sent") {
          gameInProgress = true;
          startBtn.disabled = true;
          scorePanel.classList.add("hidden");
          statusEl.textContent = "Juego iniciado üöÄ";
          statusEl.className = "font-bold text-blue-400";
        } else {
          alert("‚ö†Ô∏è No se pudo iniciar el juego (Arduino no conectado)");
        }
      });

      // Juego finalizado
      socket.on("game_over", (data) => {
        gameInProgress = false;
        startBtn.disabled = false;
        scorePanel.classList.remove("hidden");
        finalScoreEl.textContent = data.score;
        statusEl.textContent = "Juego finalizado üèÅ";
        statusEl.className = "font-bold text-yellow-400";
        
        // ¬°Confeti!
        createConfetti();
      });

      // Evento de nivel (ya no muestra imagen)
      socket.on("level_up", () => {
        // Nivel superado - ya no muestra imagen
      });

      // Guardar puntaje
      document.getElementById("saveScore").addEventListener("click", async () => {
        const name = playerNameEl.value || "Anon";
        const score = parseInt(finalScoreEl.textContent);

        const res = await fetch("/submit_score", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, score }),
        });
        const result = await res.json();
        if (result.ok) {
          alert("‚úÖ Puntaje guardado!");
          playerNameEl.value = "";
        }
      });

      // Nuevo puntaje
      socket.on("new_score", (data) => {
        const table = document.getElementById("rankingBody");
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="px-4 py-2">${data.name}</td>
          <td class="px-4 py-2 text-right">${data.score}</td>
          <td class="px-4 py-2 text-right">${new Date().toISOString().split("T")[0]}</td>
        `;
        table.prepend(row);
      });

      // Eliminar base de datos
      document.getElementById("deleteDbBtn").addEventListener("click", async () => {
        if (!confirm("‚ö†Ô∏è Esto eliminar√° toda la base de datos. ¬øSeguro?")) return;
        const res = await fetch("/delete_db", { method: "POST" });
        const data = await res.json();

        if (data.ok) {
          alert("‚úÖ " + data.msg);
          location.reload();
        } else {
          alert("‚ö†Ô∏è " + data.msg);
        }
      });
    </script>
  </body>
</html>